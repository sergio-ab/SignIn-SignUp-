<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Form Test Page</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            #responseMsg {
              margin-top: 1em;
              padding: 0.5em;
              display: none;
            }

            #responseMsg.success {
              color: green;
              background-color: #e0ffe0;
              border: 1px solid green;
            }

            #responseMsg.error {
              color: red;
              background-color: #ffe0e0;
              border: 1px solid red;
            }
        </style>

        <script type="text/javascript">
            /**
             * Validate form data and call another function to send data
             * and process response
             * @param {type} event
             * @returns {undefined}
             */
            function handleSignInOnClick (event){
                try{
                    //Obtenemos los objetos para los elementos del form
                    const tfEmail=document.getElementById("tfEmail");
                    const tfPassword=document.getElementById("tfPassword");
                    const signInForm=document.getElementById("signInForm");
                    //Creamos un objeto RegExp para validar el email
                    const emailRegExp=
                        new RegExp("^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$");
                    //Detenemos la propagaci칩n de eventos y la acci칩n por defecto
                    //del formulario
                    event.preventDefault();
                    event.stopPropagation();
                    //Validar que email y password est치n informados
                    if(tfEmail.value.trim()===""||tfPassword.value.trim()==="")
                    throw new Error("Email and password must be filled.");
                    //Validar que email and password cumplen longitud
                    if(tfEmail.value.length>255)
                    throw new Error("Email cannot have more than 255 characters.");
                    if (tfPassword.value.length>255)
                    throw new Error("Password cannot have more than 255 characters.");
                    //Validar formato de email
                    if(!emailRegExp.exec(tfEmail.value.trim()))
                    throw new Error("Email has not a valid format.");
                    //Call to function for sending data and process response
                    sendRequestAndProcessResponse();
                }catch(error){
                    //Show error messages in red styled div
                    const msgBox = document.getElementById("responseMsg");
                    msgBox.className = 'error';
                    msgBox.textContent = 'Error: ' + error.message;
                    msgBox.style.display = 'block';
                }
            }
            /**
             * Create a GET request and process HTTP OK and ERROR responses
             * using fetch API.
             * @returns {undefined}
             */
            function sendRequestAndProcessResponse (){
                //Obtenemos referencias 
                const signInForm=document.getElementById("signInForm");
                const msgBox = document.getElementById("responseMsg");
                //Obtenemos los valores de los campos
                const valueTfEmail=tfEmail.value.trim();
                const valueTfPassword=tfPassword.value.trim();
                //Realizamos la petici칩n usando el API Fetch
                fetch(signInForm.action +
                      `${encodeURIComponent(valueTfEmail)}/${encodeURIComponent(valueTfPassword)}`, 
                    {
                        method: 'GET',
                        headers: {
                          'Content-Type': 'application/xml'
                        }
                    }).then(response => {
                        //Procesado de respuesta error 401
                        if (response.status===401){
                          return response.text().then(text => {
                            throw new Error('Wrong credentials!!');
                          });
                        }
                        //Procesado de respuesta error 500
                        else if (response.status===500){
                          return response.text().then(text => {
                            throw new Error('Server Error. Please try later!!');
                          });
                        }
                        //Procesado de respuesta otro error
                        else if (!response.ok) {
                          return response.text().then(text => {
                            throw new Error(text || 'Unexpected error!!');
                          });
                        }
                        return response;
                      })
                        //Procesado de respuesta OK 
                        .then(data => {
                            msgBox.className = 'success';
                            msgBox.textContent = 'Customer signed in successfully!';
                            msgBox.style.display = 'block';
                        })
                        //Procesado de errores
                        .catch(error => {
                            msgBox.className = 'error';
                            msgBox.textContent = 'Error: ' + error.message;
                            msgBox.style.display = 'block';
                        }
                    );
          }
    </script>
    </head>
    <body style="background-color:lightblue">
        <div>Test Form</div>
        <form action="http://localhost:8080/CRUDBankServerSide/webresources/customer/sigin/"
              id="signInForm">
            <label>Email</label><br>
            <input type="email" id="tfEmail" name="tfEmail"/><br>
            <label>Password</label><br>
            <input type="password" id="tfPassword" name="tfPassword"/><br>
            <button id="btSignIn"
                    onclick="handleSignInOnClick(event);">Sign In</button>
        </form>
        <div id="responseMsg"></div>
    </body>
</html>